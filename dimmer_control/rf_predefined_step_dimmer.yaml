# Predefined Step Dimmer Script
# Basic idea: As LEDS with a dimmer often react non-linearly to brightness settings, its better to step through predefined brightness levels.
# Steps through a list of brightness percentages on each execution.
# Inputs:
#   light_entity: target light
#   steps: list of brightness percentages (e.g., [10,30,60,100])
#   bounce_at_top: boolean (true: bounce at top, false: wrap to 1)
alias: RF predefined step dimmer
mode: queued
fields:
  light_entity:
    description: Target light entity
    selector:
      entity:
        domain: light
  steps:
    description: List of brightness percentages (e.g., [10,30,60,100])
    example: "[10,30,60,100]"
    selector:
      text:
        multiline: false
  bounce_at_top:
    description: If true, after top step, next is top-1; if false, wraps to 1st
    selector:
      boolean: {}

variables:
  bounce_at_top: >
    {{ bounce_at_top | default(true) | bool }}
  steps_list: >
    {% if steps is defined and steps is iterable and steps|count > 0 %}
      {{ steps | sort }}
    {% else %}
      {{ [10, 30, 60, 100] }}
    {% endif %}

  current_pct: >
    {% set b = state_attr(light_entity, 'brightness') %}
    {% if b is number %}
      {{ (b * 100 / 255) | round(0) }}
    {% else %}
      0
    {% endif %}

  idx: >
    {% set ns = namespace(min_diff=999, idx=0) %}
    {% for i in range(steps_list | count) %}
      {% set diff = (current_pct - steps_list[i]) | abs %}
      {% if diff < ns.min_diff %}
        {% set ns.min_diff = diff %}
        {% set ns.idx = i %}
      {% endif %}
    {% endfor %}
    {{ ns.idx }}

  at_top: >
    {{ idx == (steps_list | count - 1) }}

  at_bottom: >
    {{ idx == 0 }}

  direction_state: >
    input_boolean.{{ light_entity.split('.', 1)[1] }}_dimmer_dir

  going_up: >
    {{ is_state(direction_state, 'on') }}

  next_idx: >
    {% if going_up %}
      {% if at_top %}
        {% if bounce_at_top %}
          {{ idx - 1 }}
        {% else %}
          0
        {% endif %}
      {% else %}
        {{ idx + 1 }}
      {% endif %}
    {% else %}
      {% if at_bottom %}
        1
      {% else %}
        {{ idx - 1 }}
      {% endif %}
    {% endif %}

  next_pct: >
    {{ steps_list[next_idx] }}

sequence:
  - service: light.turn_on
    target:
      entity_id: "{{ light_entity }}"
    data:
      brightness_pct: "{{ next_pct }}"
    continue_on_error: true

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ going_up and at_top and bounce_at_top }}"
        sequence:
          - service: input_boolean.turn_off
            target:
              entity_id: "{{ direction_state }}"
      - conditions:
          - condition: template
            value_template: "{{ not going_up and at_bottom }}"
        sequence:
          - service: input_boolean.turn_on
            target:
              entity_id: "{{ direction_state }}"
