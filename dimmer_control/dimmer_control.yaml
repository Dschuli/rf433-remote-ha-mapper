# Dimmer Control Script: step-by-step & predefined steps
# Parameters:
#   light_entity: (required)
#   steps: [int, int, ...] or int (default: 5)
#   min: int (default: 10, only for steps=int)
#   max: int (default: 90, only for steps=int)
#   bounce_at_top: bool (default: true)
#
# If steps is an array with multiple values, these are used as fixed steps (predefined steps).
# If steps is a single value, it is used as the step size (step-by-step).
# If the helper input_boolean.<light_entity>_dimmer_dir does not exist, bounce_at_top is set to false.

alias: Dimmer Control
mode: single
fields:
  light_entity:
    description: The light entity to control
    example: light.living_room
    required: true
  steps:
    description: Step size (int) or list of steps (array)
    example: 10 or [10,30,60,90]
  min_val:
    description: Minimum value (only for steps=int)
    selector:
      number:
        min: 0
        max: 99
        step: 1
        mode: box
  max_val:
    description: Maximum value (only for steps=int)
    selector:
      number:
        min: 1
        max: 100
        step: 1
        mode: box
  bounce_at_top:
    description: Bounce at top/bottom (only for steps=int)    
    selector:
      boolean: {}
sequence:
  - variables:
      default_steps: [ 5, 25, 50, 75, 100]
      bounce: "{{ bounce_at_top | default(true) | bool }}"
      entity: "{{ light_entity }}"
      steps: "{{ steps if steps is defined else 5 }}"
      min_val: "{{ (min_val | default(0)) | int }}"
      max_val: "{{ (max_val | default(100)) | int }}"
      dir_helper: "input_boolean.{{ entity.split('.')[-1] }}_dimmer_dir"
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ steps is iterable and steps | count == 0 }}"
        sequence:
          - variables:
              steps: "{{ default_steps }}"
      - conditions:
          - condition: template
            value_template: >
              {{ steps is iterable and (
                steps | select('number') | list | count != steps | count or
                (steps | select('number') | select('lt', 0) | list | count > 0) or
                (steps | select('number') | select('gt', 100) | list | count > 0)
              ) }}
        sequence:
          - service: system_log.write
            data:
              message: "[Dimmer Control] Warning: One or more values in 'steps' are not numbers or not in range 0-100. Script will exit."
              level: warning
          - stop: true
            response_variable: dimmer_invalid_steps_exit
      - conditions:
          - condition: template
            value_template: "{{ entity in states }}"
        sequence:
          - service: system_log.write
            data:
              message: "[Dimmer Control] Warning: 'light_entity' {{ entity }} is not valid. Script will exit."
              level: warning
          - stop: true
            response_variable: dimmer_invalid_entity_exit
      - conditions:
          - condition: template
            value_template: "{{ dir_helper in states }}"
        sequence:
          - variables:
              bounce: false
  - variables:
      brightness: >
        {% if state_attr(entity, 'brightness') is number %}
          {{ state_attr(entity, 'brightness') | int(0) }}
        {% else %}
          0
        {% endif %}
      brightness_pct: "{{ (brightness / 2.55) | round(0) | int }}"
  - choose:
      # Predefined steps mode
      - conditions:
          - condition: template
            value_template: "{{ steps is iterable and steps | count > 1 }}"
        sequence:
          - variables:
              step_list: "{{ steps | sort }}"
              ns: "{{ namespace(min_diff=999, idx=0) }}"
              idx: >
                {% set current = brightness_pct %}
                {% set ns = namespace(min_diff=999, idx=0) %}
                {% for i in range(step_list | count) %}
                  {% set diff = (current - step_list[i]) | abs %}
                  {% if diff < ns.min_diff %}
                    {% set ns.min_diff = diff %}
                    {% set ns.idx = i %}
                  {% endif %}
                {% endfor %}
                {{ ns.idx }}
              at_top: "{{ idx == (step_list | count - 1) }}"
              at_bottom: "{{ idx == 0 }}"
              dir_helper: "input_boolean.{{ entity.split('.')[-1] }}_dimmer_dir"
              going_up: "{{ is_state(dir_helper, 'on') }}"
              next_idx: >
                {% if going_up %}
                  {% if at_top %}
                    {% if bounce %}
                      {{ idx - 1 }}
                    {% else %}
                      0
                    {% endif %}
                  {% else %}
                    {{ idx + 1 }}
                  {% endif %}
                {% else %}
                  {% if at_bottom %}
                    1
                  {% else %}
                    {{ idx - 1 }}
                  {% endif %}
                {% endif %}
              next_val: "{{ step_list[next_idx] }}"
          - service: system_log.write
            data:
              message: |
                [Dimmer Control DEBUG] Predefined steps: next_val={{ next_val }}
              level: debug
          - service: light.turn_on
            target:
              entity_id: "{{ entity }}"
            data:
              brightness_pct: "{{ next_val }}"
            continue_on_error: true
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ going_up and at_top and bounce }}"
                sequence:
                  - service: input_boolean.turn_off
                    target:
                      entity_id: "{{ dir_helper }}"
                    continue_on_error: true
              - conditions:
                  - condition: template
                    value_template: "{{ not going_up and at_bottom }}"
                sequence:
                  - service: input_boolean.turn_on
                    target:
                      entity_id: "{{ dir_helper }}"
                    continue_on_error: true
        #step-by-step mode
      - conditions:
          - condition: template
            value_template: "{{ steps is number or steps | count == 1 }}"
        sequence:
          - variables:
              step: "{{ steps if steps is number else (steps[0] | int) }}"
              min_b: "{{ min_val }}"
              max_b: "{{ max_val }}"
              dir: >
                {% if bounce %}
                  {{ 1 if states(dir_helper) == 'on' else -1 }}
                {% else %}
                  1
                {% endif %}
              next_val: >
                {% set val = brightness_pct + (step * dir) %}
                {% if val >= max_b and val < max_b + step %}
                  {{ max_b }}
                {% elif val > max_b %}
                  {% if bounce %}
                    {{ max_b }}
                  {% else %}
                    {{ min_b }}
                  {% endif %}
                {% elif val < min_b %}
                  {% if bounce %}
                    {{ min_b }}
                  {% else %}
                    {{ max_b }}
                  {% endif %}
                {% else %}
                  {{ val }}
                {% endif %}
          - service: system_log.write
            data:
              message: |
                [Dimmer Control DEBUG] Step-by-step: next_val={{ next_val }}
              level: debug
          - service: light.turn_on
            target:
              entity_id: "{{ entity }}"
            data:
              brightness_pct: "{{ next_val }}"
            continue_on_error: true
          - choose:
              - conditions:
                  - condition: template
                    value_template: >
                      {{ bounce and (next_val >= max_b or next_val <= min_b) }}
                sequence:
                  - service: input_boolean.toggle
                    target:
                      entity_id: "{{ dir_helper }}"
                    continue_on_error: true
